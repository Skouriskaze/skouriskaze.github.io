<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=720">
    <title> Jesse's Bootstrap </title>

    <style>
        canvas {
            margin-left: auto;
            margin-right: auto;
            border: 1px solid black;
        }
        html, body {
            margin: 0px;
        }
    </style>

    <script type="text/javascript" src="sprite.js"> </script>

</head>
<body>
    <div> 
        <canvas id="joystick1" width="720" height="720"> </canvas>
    </div>

    <script>
        var requestAnimFrame = (function(){
            return window.requestAnimationFrame       ||
            window.webkitRequestAnimationFrame ||
            window.mozRequestAnimationFrame    ||
            window.oRequestAnimationFrame      ||
            window.msRequestAnimationFrame     ||
            function(callback){
                window.setTimeout(callback, 1000 / 60);
            };
        })();

        var joystick1 = document.getElementById("joystick1");
        var ctx1 = joystick1.getContext("2d");
        var sprites = [];

        function loadImage(paths) {
            for (var i = 0; i < paths.length; i++) {
                var img = new Image();
                if (i == paths.length - 1) {
                    img.onload = gameLoop;
                }
                img.src = paths[i];
            }
        }

        window.addEventListener('resize', function() {
                console.log("Resized");
                ctx1.canvas.height = window.innerHeight * 99 / 100;
                ctx1.canvas.width = 720;
            });

        const square_width = 16;


        var crosshair = null;
        var joystick = null;

        ctx1.canvas.height = window.innerHeight * 99 / 100;

        joystick1.addEventListener('touchstart', touchStart, false);
        joystick1.addEventListener('touchend', touchEnd, false);
        joystick1.addEventListener('mousedown', onClick, false);
        joystick1.addEventListener('mousemove', onMouseMove, false);
        joystick1.addEventListener('mouseup', onUp, false);

        window.requestAnimFrame = function () {
            return window.requestAnimationFrame ||
                window.webkitRequestAnimationFrame ||
                window.mozRequestAnimationFrame ||
                function (callback) {
                    window.setTimeout(callback, 1000 / 60)
                };
        }();

        loadImage(['res/crosshair.png', 'res/joystick.png']);

        function onClick(e) {
            var x = e.pageX - joystick1.offsetLeft;
            var y = e.pageY - joystick1.offsetTop;

            console.log(x);
            console.log(y);

            crosshair = new Sprite('res/crosshair.png', (x - 16 / 2), y - 16 / 2);
            joystick = new Sprite('res/joystick.png', (x - 100 / 2), y - 100 / 2);
            //crosshair.render(ctx1);
        }
        function touchStart(e) {
            e.preventDefault();

            ctx1.fillStyle = "blue";
            var touch = e.touches[0];
            var x = touch.pageX - joystick1.offsetLeft;
            var y = touch.pageY - joystick1.offsetTop;

            crosshair = new Sprite('res/crosshair.png', (x - 16 / 2), y - 16 / 2);
            joystick = new Sprite('res/joystick.png', (x - 100 / 2), y - 100 / 2);
        }

        function onMouseMove(e) {
            console.log("Moused");
            if (null != joystick) {
                joystick.posX = e.pageX - 100 / 2;
                joystick.posY = e.pageY - 100 / 2;
            }
        }
        
        function touchEnd(e) {
            console.log("Ended");
            crosshair = null;
            joystick = null;
        }

        function onUp(e) {
            crosshair = null;
            joystick = null;
        }

        function gameLoop() {
            render();
            requestAnimFrame(gameLoop);
        }

        function render() {
            ctx1.fillStyle = "white";
            ctx1.rect(0, 0, joystick1.width, joystick1.height);
            ctx1.fill();
            //console.log(crosshair);
            if (null != joystick) {
                joystick.render(ctx1);
            }
            if (null != crosshair) {
                //console.log("Crosshair good");
                crosshair.render(ctx1);
            }
        }

    </script>
</body>
</html>

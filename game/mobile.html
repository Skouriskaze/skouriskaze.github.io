<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=720">
    <title> Jesse's Bootstrap </title>

    <style>
        canvas {
            margin-left: auto;
            margin-right: auto;
            border: 1px solid black;
        }
        html, body {
            margin: 0px;
        }
    </style>

    <script type="text/javascript" src="sprite.js"> </script>

</head>
<body>
    <div> 
        <canvas id="joystick1" width="720" height="720"> </canvas>
    </div>

    <script>
        var requestAnimFrame = (function(){
            return window.requestAnimationFrame       ||
            window.webkitRequestAnimationFrame ||
            window.mozRequestAnimationFrame    ||
            window.oRequestAnimationFrame      ||
            window.msRequestAnimationFrame     ||
            function(callback){
                window.setTimeout(callback, 1000 / 60);
            };
        })();

        var canvas = document.getElementById("joystick1");
        var ctx1 = canvas.getContext("2d");
        var sprites = [];

        function loadImage(paths) {
            for (var i = 0; i < paths.length; i++) {
                var img = new Image();
                if (i == paths.length - 1) {
                    img.onload = gameLoop;
                }
                img.src = paths[i];
            }
        }

        window.addEventListener('resize', function() {
            console.log("Resized");
            ctx1.canvas.height = window.innerHeight * 99 / 100;
            ctx1.canvas.width = 720;
        });

        var leftJoystick = new Joystick();
        var rightJoystick = new Joystick();

        ctx1.canvas.height = window.innerHeight * 99 / 100;

        canvas.addEventListener('touchstart', touchStart, false);
        canvas.addEventListener('touchend', touchEnd, false);
        canvas.addEventListener('touchmove', onTouchMove, false);
        canvas.addEventListener('mousedown', onClick, false);
        canvas.addEventListener('mousemove', onMouseMove, false);
        canvas.addEventListener('mouseup', onUp, false);

        window.requestAnimFrame = function () {
            return window.requestAnimationFrame ||
                window.webkitRequestAnimationFrame ||
                window.mozRequestAnimationFrame ||
                function (callback) {
                    window.setTimeout(callback, 1000 / 60)
                };
        }();

        loadImage(['res/crosshair.png', 'res/joystick.png']);

        function onClick(e) {
            var x = e.pageX - canvas.offsetLeft;
            var y = e.pageY - canvas.offsetTop;


            if (!leftJoystick.instantiated && x < 720 / 2) {
                leftJoystick.extractTouch(e);
                leftJoystick.makeJoystick(-1, x, y);
            } else if (!rightJoystick.instantiated && x > 720 / 2) {
                rightJoystick.extractTouch(e);
                rightJoystick.makeJoystick(-1, x, y);
            }
        }
        function touchStart(e) {
            console.log("Touched");
            e.preventDefault();

            for (var i = 0; i < e.changedTouches.length; i++) {
                var touch = e.changedTouches[i];
                console.log(touch.identifier);
                var x = touch.pageX - canvas.offsetLeft;
                var y = touch.pageY - canvas.offsetTop;

                if (!leftJoystick.instantiated && x < 720 / 2) {
                    leftJoystick.extractTouch(touch);
                    leftJoystick.makeJoystick(touch.identifier, x, y);
                } else if (!rightJoystick.instantiated && x > 720 / 2) {
                    rightJoystick.extractTouch(touch);
                    rightJoystick.makeJoystick(touch.identifier, x, y);
                }
            }
        }

        function onMouseMove(e) {
            leftJoystick.extractTouch(e);
            rightJoystick.extractTouch(e);
        }

        function onTouchMove(e) {
            for (var i = 0; i < e.touches.length; i++) {
                var touch = e.touches[i];
                if (touch.identifier == leftJoystick.touchId) {
                    leftJoystick.extractTouch(touch);
                } else if (touch.identifier == rightJoystick.touchId) {
                    rightJoystick.extractTouch(touch);
                }
            }
        }
        
        function touchEnd(e) {
            console.log("Ended");
            for (var i = 0; i < e.changedTouches.length; i++) {
                var touch = e.changedTouches[i];
                if (touch.identifier == leftJoystick.touchId) {
                    leftJoystick.destroyJoystick();
                } else if (touch.identifier == rightJoystick.touchId) {
                    rightJoystick.destroyJoystick();
                }
            }
        }

        function onUp(e) {
            leftJoystick.destroyJoystick();
            rightJoystick.destroyJoystick();
        }

        function gameLoop() {
            update();
            render();
            requestAnimFrame(gameLoop);
        }

        function update() {
            leftJoystick.update();
            rightJoystick.update();
        }

        function render() {
            ctx1.fillStyle = "white";
            ctx1.rect(0, 0, canvas.width, canvas.height);
            ctx1.fill();

            leftJoystick.render(ctx1);
            rightJoystick.render(ctx1);
        }

    </script>
</body>
</html>
